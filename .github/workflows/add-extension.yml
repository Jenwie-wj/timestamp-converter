# 修正版 workflow：为出错的 run step 明确指定 shell、打开更严格的调试选项（set -euxo pipefail）
# 并去掉可能掩盖错误的 `|| true`，方便看到真实报错位置。
name: Add Timestamp Converter Extension

on:
  workflow_dispatch: {}

jobs:
  add-extension:
    name: Create branch, add extension files and open PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Create files, commit and push to a new branch
        id: create_and_push
        run: |
          # 开启严格模式并输出命令，便于定位错误
          set -euxo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          BRANCH="add/timestamp-converter-$(date +%s)"
          git checkout -b "$BRANCH"

          mkdir -p icons

          cat > manifest.json <<'EOF'
{
  "manifest_version": 3,
  "name": "Timestamp⇄Date Converter",
  "description": "在可选时区下进行时间戳（秒/毫秒）与年月日相互转换（支持毫秒）",
  "version": "1.0.0",
  "action": {
    "default_title": "时间戳与日期转换器",
    "default_popup": "popup.html"
  },
  "icons": {
    "16": "icons/icon16.svg",
    "48": "icons/icon48.svg",
    "128": "icons/icon128.svg"
  },
  "permissions": []
}
EOF

          cat > popup.html <<'EOF'
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>时间戳⇄日期转换</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>时间戳 ⇄ 年月日（可选时区）</h2>

    <div class="section">
      <h3>1) 时间戳 → 日期</h3>
      <label>时间戳输入（数字）</label>
      <input id="ts-input" placeholder="例如：1633072800 或 1633072800123" />
      <div class="row">
        <label><input type="radio" name="ts-unit" value="s" checked /> 秒</label>
        <label><input type="radio" name="ts-unit" value="ms" /> 毫秒</label>
      </div>

      <label>时区偏移（小时，默认 +8）</label>
      <input id="tz-offset-ts" type="number" step="0.25" value="8" />

      <div class="row">
        <button id="btn-ts-to-date">转换为日期</button>
        <button id="btn-copy-date">复制结果</button>
      </div>

      <label>结果（YYYY-MM-DD HH:mm:ss.SSS）</label>
      <textarea id="ts-result" readonly></textarea>
    </div>

    <hr/>

    <div class="section">
      <h3>2) 日期 → 时间戳</h3>
      <label>日期输入（可只写日期或写到秒/毫秒）</label>
      <input id="date-input" placeholder="例如：2025-12-02 15:30:45 或 2025-12-02 15:30:45.123" />

      <label>时区偏移（小时，默认 +8）</label>
      <input id="tz-offset-date" type="number" step="0.25" value="8" />

      <div class="row">
        <label><input type="radio" name="date-out-unit" value="s" checked /> 输出秒</label>
        <label><input type="radio" name="date-out-unit" value="ms" /> 输出毫秒</label>
      </div>

      <div class="row">
        <button id="btn-date-to-ts">转换为时间戳</button>
        <button id="btn-copy-ts">复制结果</button>
      </div>

      <label>结果</label>
      <textarea id="date-result" readonly></textarea>
    </div>

    <hr/>
    <div class="note">
      说明：
      <ul>
        <li>时区以“UTC 偏移小时”为单位（支持小数，如 -5.5）。默认 +8（北京时间）。</li>
        <li>日期解析支持 "YYYY-MM-DD", "YYYY-MM-DD HH:mm", "YYYY-MM-DD HH:mm:ss", "YYYY-MM-DD HH:mm:ss.SSS" 格式。</li>
      </ul>
    </div>
  </div>

  <script src="popup.js"></script>
</body>
</html>
EOF

          cat > style.css <<'EOF'
:root{
  --bg:#f7f8fa;
  --card:#ffffff;
  --accent:#0b74de;
  --muted:#666;
}
*{box-sizing:border-box;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{margin:0;padding:12px;background:var(--bg);color:#111}
.container{max-width:520px;margin:0 auto}
h2{font-size:16px;margin:0 0 12px}
.section{background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
input[type="text"], input[type="number"], textarea{
  width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;font-size:14px;
}
textarea{height:56px;resize:vertical}
.row{display:flex;gap:8px;align-items:center;margin-top:10px}
button{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
button[disabled]{opacity:0.6;cursor:default}
.note{font-size:12px;color:var(--muted);padding:8px}
hr{border:none;height:1px;background:#eee;margin:12px 0}
EOF

          cat > popup.js <<'EOF'
// Popup script for timestamp <-> date converter (offset-based timezones)
(function(){
  // Utils
  function pad(n, width=2){ return String(n).padStart(width,'0'); }
  function padMs(n){ return String(n).padStart(3,'0'); }

  function formatDateFromMs(ms){
    const d = new Date(ms);
    const Y = d.getUTCFullYear();
    const M = pad(d.getUTCMonth()+1);
    const D = pad(d.getUTCDate());
    const h = pad(d.getUTCHours());
    const m = pad(d.getUTCMinutes());
    const s = pad(d.getUTCSeconds());
    const msPart = padMs(d.getUTCMilliseconds());
    return `${Y}-${M}-${D} ${h}:${m}:${s}.${msPart}`;
  }

  // timestamp (s or ms) -> formatted date string in timezone offset hours
  function tsToDateString(value, unit, offsetHours){
    if(isNaN(Number(value))) return '输入无效';
    let msUTC = Number(value);
    if(unit === 's') msUTC = msUTC * 1000;
    // local ms in that timezone = UTC ms + offsetHours*3600000
    const localMs = msUTC + offsetHours * 3600000;
    return formatDateFromMs(localMs) + ` (UTC${offsetHours>=0?'+':''}${offsetHours})`;
  }

  // date string -> timestamp (s or ms). dateStr formats:
  // YYYY-MM-DD [HH:mm[:ss[.SSS]]]
  function dateStringToTs(dateStr, outUnit, offsetHours){
    // normalize spaces
    const s = dateStr.trim();
    const re = /^(\d{4})-(\d{1,2})-(\d{1,2})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2})(?:\.(\d{1,3}))?)?)?$/;
    const m = re.exec(s);
    if(!m) return { ok:false, text:'日期格式不匹配。允许格式：YYYY-MM-DD 或 YYYY-MM-DD HH:mm[:ss[.SSS]]' };
    const year = Number(m[1]), month = Number(m[2]), day = Number(m[3]);
    const hour = Number(m[4]||0), minute = Number(m[5]||0), second = Number(m[6]||0), ms = Number((m[7]||'0').padEnd(3,'0'));
    // Compute UTC ms for that wall-clock time in the given timezone:
    // UTCms = Date.UTC(year, month-1, day, hour, minute, second, ms) - offsetHours*3600000
    const utcMs = Date.UTC(year, month-1, day, hour, minute, second, ms) - offsetHours * 3600000;
    if(outUnit === 's') return { ok:true, value: Math.floor(utcMs/1000) };
    return { ok:true, value: utcMs };
  }

  // DOM
  const tsInput = document.getElementById('ts-input');
  const tzOffsetTs = document.getElementById('tz-offset-ts');
  const btnTsToDate = document.getElementById('btn-ts-to-date');
  const tsResult = document.getElementById('ts-result');
  const btnCopyDate = document.getElementById('btn-copy-date');

  const dateInput = document.getElementById('date-input');
  const tzOffsetDate = document.getElementById('tz-offset-date');
  const btnDateToTs = document.getElementById('btn-date-to-ts');
  const dateResult = document.getElementById('date-result');
  const btnCopyTs = document.getElementById('btn-copy-ts');

  function getSelectedRadioValue(name){
    const els = document.getElementsByName(name);
    for(const e of els) if(e.checked) return e.value;
    return null;
  }

  btnTsToDate.addEventListener('click', ()=>{
    const val = tsInput.value.trim();
    const unit = getSelectedRadioValue('ts-unit'); // s or ms
    let offset = Number(tzOffsetTs.value);
    if(isNaN(offset)) offset = 8;
    const res = tsToDateString(val, unit, offset);
    tsResult.value = res;
  });

  btnDateToTs.addEventListener('click', ()=>{
    const val = dateInput.value.trim();
    let offset = Number(tzOffsetDate.value);
    if(isNaN(offset)) offset = 8;
    const outUnit = getSelectedRadioValue('date-out-unit'); // s or ms
    const r = dateStringToTs(val, outUnit, offset);
    if(!r.ok){ dateResult.value = r.text; return; }
    dateResult.value = String(r.value) + (outUnit==='s' ? ' (秒)' : ' (毫秒)');
  });

  btnCopyDate.addEventListener('click', async ()=>{
    const txt = tsResult.value.trim();
    if(!txt) return;
    try{
      await navigator.clipboard.writeText(txt);
      btnCopyDate.textContent = '已复制';
      setTimeout(()=>btnCopyDate.textContent='复制结果',1200);
    }catch(e){ alert('复制失败：' + e); }
  });

  btnCopyTs.addEventListener('click', async ()=>{
    const txt = dateResult.value.trim();
    if(!txt) return;
    try{
      await navigator.clipboard.writeText(txt);
      btnCopyTs.textContent = '已复制';
      setTimeout(()=>btnCopyTs.textContent='复制结果',1200);
    }catch(e){ alert('复制失败：' + e); }
  });

  // small helpers: example shortcuts on enter
  tsInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') btnTsToDate.click();
  });
  dateInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') btnDateToTs.click();
  });

  // Provide example initial values
  tsInput.placeholder = '例如：1633072800 或 1633072800123';
  dateInput.placeholder = '例如：2025-12-02 15:30:45 或 2025-12-02 15:30:45.123';

})();
EOF

          cat > icons/icon16.svg <<'EOF'
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
  <rect width="24" height="24" rx="4" fill="#0b74de"/>
  <text x="12" y="16" font-size="10" font-family="Arial" fill="#fff" text-anchor="middle">TS</text>
</svg>
EOF

          cat > icons/icon48.svg <<'EOF'
<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
  <rect width="24" height="24" rx="4" fill="#0b74de"/>
  <text x="12" y="16" font-size="10" font-family="Arial" fill="#fff" text-anchor="middle">TS</text>
</svg>
EOF

          cat > icons/icon128.svg <<'EOF'
<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24">
  <rect width="24" height="24" rx="4" fill="#0b74de"/>
  <text x="12" y="16" font-size="10" font-family="Arial" fill="#fff" text-anchor="middle">TS</text>
</svg>
EOF

          cat > README.md <<'EOF'
# Timestamp ⇄ Date Chrome 插件

一个简单的 Chrome 扩展（Manifest V3），用于在指定时区（以 UTC 偏移小时为准）下进行时间戳（秒/毫秒）与年月日互转。

功能
- 时间戳（秒或毫秒） → 指定时区的日期时间（支持毫秒）
- 日期字符串（支持毫秒） → 指定时区下的时间戳（秒或毫秒）
- 时区以“UTC 偏移小时”为准（支持小数，例如 -5.5），默认 UTC+8

安装（开发者模式，本地加载）
1. 将本仓库克隆或下载到本地。
2. 在 Chrome 地址栏打开 chrome://extensions/ 并开启“开发者模式”。
3. 点击“加载已解压的扩展程序”，选择本项目根目录即可。

日期格式支持
- YYYY-MM-DD
- YYYY-MM-DD HH:mm
- YYYY-MM-DD HH:mm:ss
- YYYY-MM-DD HH:mm:ss.SSS

备注
- 当前实现基于 UTC 偏移小时，不使用 IANA 时区数据库；如需精确处理夏令时与 IANA 时区（例如 Asia/Shanghai），可以在后续版本中引入 Luxon / Intl 支持。
EOF

          git add .
          git commit -m "Add timestamp converter Chrome extension (Manifest V3)"
          git push --set-upstream origin "$BRANCH"

          # 导出分支名供后续步骤使用
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Add timestamp converter Chrome extension (Manifest V3)'
          title: 'Add timestamp converter Chrome extension (Manifest V3)'
          body: |
            This PR adds the Chrome extension files for timestamp⇄date conversion (Manifest V3).
          base: main
          head: ${{ steps.create_and_push.outputs.branch }}
